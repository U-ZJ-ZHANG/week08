name: CD - Deploy Frontend to AKS

on:
  workflow_dispatch:

jobs:
  deploy_frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set Kubernetes context
      run: |
        az aks get-credentials --resource-group sit722-rg --name sit722-aks --overwrite-existing

    # 确保 frontend-deployment 存在，不然直接 set image 会报错
    - name: Apply Frontend Deployment
      run: kubectl apply -f k8s/frontend-deployment.yaml

    - name: Deploy Frontend
      run: kubectl set image deployment/frontend-deployment frontend=sit722devopszzjacr.azurecr.io/frontend:latest -n default

    - name: Logout from Azure
      run: az logout
      if: always()
