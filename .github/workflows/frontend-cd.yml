name: Frontend CD

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ✅ 拉取代码
      - uses: actions/checkout@v4

      # ✅ 登录 ACR（用 secrets，而不是 SP）
      - name: ACR Login
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_LOGIN_SERVER }} -u ${{ secrets.ACR_USERNAME }} --password-stdin

      # ✅ 构建并推送 frontend 镜像
      - name: Build & Push Frontend
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/frontend:$IMAGE_TAG frontend
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/frontend:$IMAGE_TAG

      # ✅ 设置 kubeconfig（直接用 secrets）
      - name: Set kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" > $HOME/kubeconfig
          export KUBECONFIG=$HOME/kubeconfig
          kubectl config view --minify --flatten

      # ✅ 部署 frontend，更新镜像 tag
      - name: Deploy manifests
        run: |
          export KUBECONFIG=$HOME/kubeconfig
          IMAGE_TAG=${GITHUB_SHA}
          kubectl set image deployment/frontend frontend-container=${{ secrets.ACR_LOGIN_SERVER }}/frontend:$IMAGE_TAG -n default || \
          kubectl apply -f k8s/frontend.yaml -n default